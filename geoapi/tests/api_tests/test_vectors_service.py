from geoapi.services.vectors import VectorService
import fiona
import pytest


def test_process_shapefile(shapefile_fixture, shapefile_additional_files_fixture):
    geom, properties = next(VectorService.process_shapefile(shapefile_fixture,
                                                            additional_files=shapefile_additional_files_fixture))

    assert geom.wkt == ("MULTIPOLYGON (((-68.63401022758323 -52.63637045887449, -68.63335000000001 -54.8695,"
                        " -67.56244 -54.87001, -66.95992000000001 -54.89681000000002,"
                        " -67.29102999999992 -55.30123999999995, -68.14862999999991 -55.61183,"
                        " -68.63999081081187 -55.58001799908692, -69.2321 -55.49905999999993,"
                        " -69.95808999999997 -55.19843000000003, -71.00567999999998 -55.05383,"
                        " -72.26390000000004 -54.49513999999999, -73.28519999999997 -53.95751999999993,"
                        " -74.66253 -52.83748999999995, -73.8381 -53.04743000000002,"
                        " -72.43417999999997 -53.71539999999999, -71.10773 -54.07432999999992,"
                        " -70.59177999999986 -53.61582999999996, -70.26747999999998 -52.93123000000003,"
                        " -69.34564999999992 -52.51829999999995, -68.63401022758323 -52.63637045887449)),"
                        " ((-69.59042375352405 -17.58001189541933, -69.10024695501949 -18.26012542081268,"
                        " -68.96681840684187 -18.98168344490411, -68.44222510443092 -19.40506845467143,"
                        " -68.75716712103375 -20.37265797290446, -68.21991309271128 -21.49434661223187,"
                        " -67.82817989772273 -22.87291879648217, -67.1066735500636 -22.73592457447642,"
                        " -66.9852339341777 -22.98634856536284, -67.32844295924417 -24.02530323659095,"
                        " -68.41765296087614 -24.51855478281688, -68.38600114609736 -26.18501637136522,"
                        " -68.59479977077268 -26.5069088681113, -68.29554155137043 -26.89933969493578,"
                        " -69.00123491074825 -27.52121388113618, -69.65613033718317 -28.45914112723369,"
                        " -70.01355038112992 -29.36792286551857, -69.91900834825194 -30.33633920666828,"
                        " -70.53506893581951 -31.36501026787031, -70.07439938015359 -33.09120981214805,"
                        " -69.81477698431922 -33.27388600029983, -69.81730912950152 -34.1935714657983,"
                        " -70.38804948594913 -35.16968759535949, -70.36476925320164 -36.00508879978992,"
                        " -71.12188066270987 -36.65812387466232, -71.11862504747549 -37.57682748794724,"
                        " -70.81466427273469 -38.55299529394074, -71.41351660834906 -38.91602223079114,"
                        " -71.68076127794649 -39.80816415787805, -71.91573401557763 -40.83233936947069,"
                        " -71.7468037584155 -42.05138640723598, -72.14889807807856 -42.25488819760137,"
                        " -71.91542395698389 -43.40856454851745, -71.46405615913051 -43.78761117937835,"
                        " -71.79362260607193 -44.20717213315606, -71.32980078803622 -44.40752166115166,"
                        " -71.22277889675976 -44.78424285255942, -71.65931555854536 -44.97368865334143,"
                        " -71.55200944689128 -45.5607329241771, -71.91725847033024 -46.88483814879177,"
                        " -72.44735531278027 -47.73853281025352, -72.33116085477201 -48.2442383766618,"
                        " -72.64824744331494 -48.87861825947683, -73.41543575712009 -49.31843637471297,"
                        " -73.32805091011453 -50.37878508890991, -72.97574683296469 -50.74145029073429,"
                        " -72.30997351753234 -50.67700977966632, -72.32940385607407 -51.42595631287243,"
                        " -71.91480383979638 -52.0090223058659, -69.49836218939609 -52.14276091263727,"
                        " -68.57154537624133 -52.29944385534623, -69.46128434922667 -52.29195077266391,"
                        " -69.9427795071062 -52.53793059037322, -70.8451016913546 -52.89920052852571,"
                        " -71.00633216010525 -53.83325204220132, -71.429794684521 -53.85645476030037,"
                        " -72.55794287788488 -53.53141000118449, -73.7027567206629 -52.83506926860723,"
                        " -73.7027567206629 -52.83507007605149, -74.94676347522517 -52.262753588419,"
                        " -75.26002600777851 -51.62935475037325, -74.97663245308988 -51.0433956846157,"
                        " -75.47975419788355 -50.37837167745158, -75.60801510283198 -48.67377288187184,"
                        " -75.18276974150216 -47.7119194476232, -74.12658098010471 -46.93925343199511,"
                        " -75.64439531116545 -46.64764332457207, -74.69215369332312 -45.76397633238103,"
                        " -74.35170935738425 -44.10304412208794, -73.24035600451522 -44.4549606259956,"
                        " -72.71780392117979 -42.38335580827898, -73.38889990913822 -42.11753224056957,"
                        " -73.70133561877488 -43.36577646257977, -74.33194312203261 -43.22495818458442,"
                        " -74.01795711942719 -41.79481292090683, -73.67709937202999 -39.94221282324317,"
                        " -73.21759253609065 -39.25868865331856, -73.50555945503712 -38.28288258235111,"
                        " -73.58806087919109 -37.15628468195598, -73.1667170884993 -37.12378020604439,"
                        " -72.55313696968174 -35.50884002049106, -71.86173214383263 -33.90909270603153,"
                        " -71.4384504869299 -32.41889942803078, -71.66872066922247 -30.92064462659249,"
                        " -71.37008256700773 -30.09568206148503, -71.48989437527645 -28.86144215262592,"
                        " -70.90512386746161 -27.64037973400125, -70.72495398627599 -25.70592416758726,"
                        " -70.40396582709502 -23.62899667734457, -70.09124589708074 -21.39331918710126,"
                        " -70.16441972520605 -19.75646819425616, -70.37257239447771 -18.34797535570887,"
                        " -69.85844356960587 -18.09269378018701, -69.59042375352405 -17.58001189541933)))")
    assert properties == {'continent': 'South America', 'gdp_md_est': 436100.0, 'iso_a3': 'CHL',
                          'name': 'Chile', 'pop_est': 17789267}


def test_process_shapefile_missing_additional_files(shapefile_fixture):
    with pytest.raises(fiona.errors.DriverError):
        _, _ = next(VectorService.process_shapefile(shapefile_fixture, additional_files=[]))
